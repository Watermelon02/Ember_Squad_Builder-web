<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>统计仪表盘</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding:20px; background:#f7fafc; color:#111; }
    h1 { margin-top: 0; }
    .card { background:white; padding:12px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.06); margin-bottom:16px;}
    table { width:100%; border-collapse:collapse; margin-top:8px;}
    th, td { text-align:left; padding:8px; border-bottom:1px solid #eee; font-size:14px;}
    th { background:#fafafa; font-weight:600; }
    .row { display:flex; gap:12px; align-items:center; }
    .small { font-size:12px; color:#666; }
    .loading { color:#888; }
  </style>
</head>
<body>
  <h1>实时统计仪表盘</h1>
  <div class="card">
    <div class="row">
      <strong>当前总队伍数：</strong>
      <div id="totalTeams" class="small loading">加载中...</div>
      <button id="refreshBtn">刷新</button>
    </div>
  </div>

  <div class="card">
    <strong>每个派系的队伍数</strong>
    <table id="factionTable"><thead><tr><th>派系</th><th>队伍数</th></tr></thead><tbody><tr><td colspan="2" class="loading">加载中...</td></tr></tbody></table>
  </div>

  <div class="card">
    <strong>每个派系 — 部件选取排行</strong>
    <div id="partsContainer" class="small loading">加载中...</div>
  </div>

  <div class="card">
    <strong>每个派系 — 驾驶员选取排行</strong>
    <div id="pilotContainer" class="small loading">加载中...</div>
  </div>

  <div class="card">
    <strong>每个派系 — 无人机选取排行</strong>
    <div id="droneContainer" class="small loading">加载中...</div>
  </div>

<script>
  const API_BASE = 'https://4watermelon.fun/api/stats'; // 如果后端不在同域，改成完整地址，如 https://4watermelon.fun/api/stats

  async function fetchJson(path) {
    const res = await fetch(API_BASE + path);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  }

  async function loadTotal() {
    try {
      const data = await fetchJson('/total-teams');
      document.getElementById('totalTeams').textContent = data.total_teams ?? '0';
    } catch (e) {
      document.getElementById('totalTeams').textContent = '错误: ' + e.message;
    }
  }

  async function loadFactionTable() {
    const tbody = document.querySelector('#factionTable tbody');
    tbody.innerHTML = '<tr><td colspan="2" class="loading">加载中...</td></tr>';
    try {
      const list = await fetchJson('/teams-by-faction');
      if (!list || list.length===0) {
        tbody.innerHTML = '<tr><td colspan="2">无数据</td></tr>';
        return;
      }
      tbody.innerHTML = list.map(r => `<tr><td>${r.factionType}</td><td>${r.team_count}</td></tr>`).join('');
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="2">错误: ${e.message}</td></tr>`;
    }
  }

  // parts ranking: 按 faction 分组显示每个 partType 的 top 列表
  async function loadPartsRanking() {
    const container = document.getElementById('partsContainer');
    container.textContent = '加载中...';
    try {
      const list = await fetchJson('/parts-ranking'); // [{factionType, partType, partID, pick_count}, ...]
      if (!list || list.length===0) { container.textContent = '无数据'; return; }

      // 组织为： faction -> partType -> array
      const grouped = {};
      list.forEach(r => {
        const f = r.factionType || 'UNKNOWN';
        grouped[f] = grouped[f] || {};
        const pt = r.partType || 'unknown';
        grouped[f][pt] = grouped[f][pt] || [];
        grouped[f][pt].push(r);
      });

      // 渲染
      let html = '';
      for (const faction of Object.keys(grouped)) {
        html += `<h4>${faction}</h4>`;
        for (const partType of Object.keys(grouped[faction])) {
          html += `<div><strong>${partType}</strong><table><thead><tr><th>部件ID</th><th>次数</th></tr></thead><tbody>`;
          grouped[faction][partType].forEach(row => {
            html += `<tr><td>${row.partID}</td><td>${row.pick_count}</td></tr>`;
          });
          html += `</tbody></table></div>`;
        }
      }
      container.innerHTML = html;
    } catch (e) {
      container.textContent = '错误: ' + e.message;
    }
  }

  async function loadPilotRanking() {
    const container = document.getElementById('pilotContainer');
    container.textContent = '加载中...';
    try {
      const list = await fetchJson('/pilot-ranking'); // [{ factionType, pilotID, pick_count }, ...]
      if (!list || list.length === 0) { container.textContent='无数据'; return; }

      const grouped = {};
      list.forEach(r => {
        const f = r.factionType || 'UNKNOWN';
        grouped[f] = grouped[f] || [];
        grouped[f].push(r);
      });

      let html = '';
      for (const faction of Object.keys(grouped)) {
        html += `<h4>${faction}</h4><table><thead><tr><th>PilotID</th><th>次数</th></tr></thead><tbody>`;
        grouped[faction].forEach(r => {
          html += `<tr><td>${r.pilotID}</td><td>${r.pick_count}</td></tr>`;
        });
        html += `</tbody></table>`;
      }
      container.innerHTML = html;
    } catch (e) {
      container.textContent = '错误: ' + e.message;
    }
  }

  async function loadDroneRanking() {
    const container = document.getElementById('droneContainer');
    container.textContent = '加载中...';
    try {
      const list = await fetchJson('/drone-ranking'); // [{ factionType, droneID, pick_count }, ...]
      if (!list || list.length === 0) { container.textContent='无数据'; return; }

      const grouped = {};
      list.forEach(r => {
        const f = r.factionType || 'UNKNOWN';
        grouped[f] = grouped[f] || [];
        grouped[f].push(r);
      });

      let html = '';
      for (const faction of Object.keys(grouped)) {
        html += `<h4>${faction}</h4><table><thead><tr><th>DroneID</th><th>次数</th></tr></thead><tbody>`;
        grouped[faction].forEach(r => {
          html += `<tr><td>${r.droneID}</td><td>${r.pick_count}</td></tr>`;
        });
        html += `</tbody></table>`;
      }
      container.innerHTML = html;
    } catch (e) {
      container.textContent = '错误: ' + e.message;
    }
  }

  async function refreshAll() {
    document.getElementById('totalTeams').textContent = '加载中...';
    document.querySelector('#factionTable tbody').innerHTML = '<tr><td colspan="2" class="loading">加载中...</td></tr>';
    document.getElementById('partsContainer').textContent = '加载中...';
    document.getElementById('pilotContainer').textContent = '加载中...';
    document.getElementById('droneContainer').textContent = '加载中...';

    await Promise.all([
      loadTotal(),
      loadFactionTable(),
      loadPartsRanking(),
      loadPilotRanking(),
      loadDroneRanking()
    ]).catch(e => console.error(e));
  }

  document.getElementById('refreshBtn').addEventListener('click', refreshAll);

  // 初始加载
  refreshAll();
</script>
</body>
</html>
